<?php

use App\Core\Config;

$parcelModel = $this->var('parcelModel');
$parcel = $parcelModel?->getData() ?? [];
$parcelBlocks = $parcelModel?->getBlocks();
?>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
  /* ───────── modal styles ───────── */
  #blockModal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, .4);
    opacity: 0;
    visibility: hidden;
    transition: .2s;
    z-index: 500;
  }

  #blockModal.show {
    opacity: 1;
    visibility: visible
  }

  .modal-card {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    width: 340px;
    padding: 1rem;
    max-height: 90vh;
    overflow: auto;
  }

  .modal-card h3 {
    margin: 0 0 .6rem
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: .6rem;
    margin-top: .8rem
  }
</style>
<script>
  function addBlockDialog() {
    document.getElementById('blockModal').classList.add('show');
  }

  function closeBlockModal() {
    document.getElementById('blockModal').classList.remove('show');
    document.getElementById('blockModal').querySelectorAll('input:not([type="hidden"]),textarea,select').forEach(el => el.value = '');
  }

  document.addEventListener('DOMContentLoaded', () => {
    <?php
    if (($parcelBlocks?->count() ?? 0) < 1 && $parcel['id']) : ?>
      //Portal.notify('Please add at least one block to the parcel', 'message');
      addBlockDialog();
    <?php
    endif
    ?>
  });
</script>



<div class=" entity-form">

  <form method="post" id="parcel-form" class="card">
      <?php
      //if (User::
        ?>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
        <h2>Parcel Info</h2>
      <?php if ($parcel['id'] && $parcelModel->canRequestService()): ?>
        <div class="button-top-set">
          <a class="btn brand-yellow" href="/?q=service/request&parcel=<?= $parcel['id'] ?>">Request Service</a>
        </div>
      <?php endif ?>
    </div>
      
      <div class="fld">
        <input name="parcel[name]" placeholder=" " required value="<?= htmlspecialchars($parcel['name']) ?>">
        <label>Parcel Identifier</label>
      </div>
      <div class="fld">
        <input name="parcel[street]" placeholder=" " value="<?= htmlspecialchars($parcel['street']) ?>" required>
        <label>Street</label>
      </div>
      <div class="fld">
        <select name="parcel[state]" required>
          <option value="" hidden></option>
          <?php foreach (Config::get('states') ?? [] as $code => $name): ?>
            <option
              value="<?= $code ?>"
              <?php if ($code === $parcel['state']): ?>
              selected
              <?php endif ?>><?= $name ?></option>
          <?php endforeach ?>
        </select>
        <label>State</label>
      </div>
      <div class="fld">
        <input name="parcel[city]" placeholder=" " value="<?= htmlspecialchars($parcel['city']) ?>" required>
        <label>City</label>
      </div>
      <div class="fld">
        <input name="parcel[zip]" placeholder=" " value="<?= htmlspecialchars($parcel['zip']) ?>" required>
        <label>ZIP</label>
      </div>
      <div class="fld">
        <input type="hidden" id="parcel-latitude" name="parcel[latitude]" value="<?= htmlspecialchars($parcel['latitude']) ?>" required>
        <input type="hidden" id="parcel-longitude" name="parcel[longitude]" value="<?= htmlspecialchars($parcel['longitude']) ?>" required>
        <label>Location</label>
        <div id="parcel-minimap" style="height: 220px; margin-top: 0.5rem; border-radius: 8px; overflow: hidden;"></div>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var lat = parseFloat(document.getElementById('parcel-latitude').value) || 37.0902;
          var lng = parseFloat(document.getElementById('parcel-longitude').value) || -95.7129;
          var hasLocation = !isNaN(parseFloat(document.getElementById('parcel-latitude').value)) && !isNaN(parseFloat(document.getElementById('parcel-longitude').value));
          var map = L.map('parcel-minimap', {
            center: [lat, lng],
            zoom: hasLocation ? 12 : 4,
            scrollWheelZoom: false,
            zoomControl: true,
            attributionControl: false
          });

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
          }).addTo(map);

          var marker = null;
          if (hasLocation) {
            marker = L.marker([lat, lng], {
              draggable: true
            }).addTo(map);
          }

          function updateLatLng(latlng) {
            document.getElementById('parcel-latitude').value = latlng.lat.toFixed(7);
            document.getElementById('parcel-longitude').value = latlng.lng.toFixed(7);
          }

          map.on('click', function(e) {
            if (!marker) {
              marker = L.marker(e.latlng, {
                draggable: true
              }).addTo(map);
              marker.on('dragend', function(ev) {
                updateLatLng(ev.target.getLatLng());
              });
            } else {
              marker.setLatLng(e.latlng);
            }
            updateLatLng(e.latlng);
          });

          if (marker) {
            marker.on('dragend', function(ev) {
              updateLatLng(ev.target.getLatLng());
            });
          }
        });
      </script>

      <div class="fld">
        <textarea name="parcel[notes]" placeholder=" " rows="3"><?= htmlspecialchars($parcel['notes']) ?></textarea>
        <label>Notes</label>
      </div>
    <div class=button-set>
      <!--button class="btn cancel" type="button" onclick="location.href='/?q=parcel/index'">Back to List</button-->
      <button class="btn cancel" type="button" onclick="window.history.back()">Back</button>
      <div style="display:flex;gap:1rem">
        <button class="btn end brand-green" type="submit">
          <?php if ($parcel['id']): ?>
            Save
          <?php else: ?>
            Create
          <?php endif ?>
        </button>
      </div>
    </div>
  </form>

  <?php if ($parcel['id']): ?>
  <fieldset class="card">
    <legend>Blocks</legend>
    <div class="flex" style="flex-direction:row;justify-content:flex-end;align-items:center;margin-bottom:1rem">
      <?php if ($parcelModel->isBlockLimitReached()): ?>
        <span class="warning">Blocks limit for the parcel is reached</span>
      <?php else: ?>
        <button class="btn" type="button" onclick="addBlockDialog()">Quick Add Block</button>
      <?php endif ?>
    </div>
    <?php if ($parcelBlocks->count() > 0): ?>
      <table class="grid" width="100%">
        <thead>
          <tr>
            <!--th>Status</th-->
            <th>
              Block Identifier
            </th>
            <th>Acres</th>
            <th>Usage Type</th>
            <th></th>
          </tr>
        </thead>
        <tbody>

          <?php foreach ($parcelBlocks ?? [] as $blockModel):
            $block = $blockModel->getData();
          ?>
            <tr class="">

              <!--td><?= htmlspecialchars($block['status']) ?></td-->
              <td class="tooltipable">
                <a href="/?q=block/edit&id=<?= $block['id'] ?>"><?= htmlspecialchars($block['name']) ?></a>
                <div class="tooltip">
                  <?= htmlspecialchars($block['notes']) ?>
                </div>
              </td>
              <td><?= htmlspecialchars($block['acres']) ?></td>
              <td><?= htmlspecialchars($block['crop_category']) ?></td>
              <td>
                <div class="action-wrap" style="position:relative; text-align:right">
                  <button class="action-btn">⋮</button>
                  <div class="actions-menu" style="text-align:left">
                    <a href="/?q=block/edit&id=<?= $block['id'] ?>">Edit</a>
                    <div class="sep"></div>
                    <a class="hover-brand-green" href="/?q=service/request&parcel=<?= $block['parcel_id'] ?>&block=<?= $block['id'] ?>">Request Service</a>
                  </div>

                </div>
              </td>
            </tr>
          <?php endforeach; ?>
      </table>
    <?php endif ?>
  </fieldset>
  <?php endif; ?>


</div>


<div id="blockModal">
  <form method="post" id="blockForm" action="/?q=block/add">
    <input type="hidden" name="block[parcel_id]" value="<?= $parcel['id'] ?>">
    <div class="modal-card">
      <h3 id="modalTitle">Add Block</h3>

      <div class="fld">
        <input name="block[name]" placeholder=" " required>
        <label>Block Identifier</label>
      </div>

      <div class="fld">
        <select name="block[crop_category]" required>
          <option value="" hidden></option>
          <?php foreach (Config::get('crop_category') ?? [] as $cat): ?>
            <option value="<?= $cat ?>"><?= htmlspecialchars($cat) ?></option>
          <?php endforeach ?>
        </select>
        <label>Usage Type</label>
      </div>

      <!--div class="fld"><input type="number" step="0.01" name="block[acres]" placeholder=" " required><label>Acres</label></div-->
      <div class="fld"><textarea name="block[notes]" placeholder=" " rows="2"></textarea><label>Notes</label></div>

      <div class="modal-footer">
        <button class="btn cancel" type="button" onclick="closeBlockModal()">Cancel</button>
        <button class="btn" type="submit">Add</button>
      </div>
    </div>
  </form>
</div>