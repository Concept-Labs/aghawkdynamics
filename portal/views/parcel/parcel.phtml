<style>
  #parcel-form {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
  }

  #parcel-form h2 {
    text-align: center;
    margin-bottom: 20px;
  }
</style>
<?php

use App\Core\Debug;

$parcel = $this->var('parcel', []);
?>
<div id="parcel-form">
  <div class="card">
    <h2>
    <?php if ($parcel['id']): ?>
      Edit Parcel
    <?php else: ?>
      Add Parcel
    <?php endif ?>
  </h2>
    <form method="post">
      <div class="fld"><input name="name" placeholder=" " required
          value="<?= htmlspecialchars($parcel['name']) ?>"><label>Name</label></div>
      <div class="fld"><input name="street" placeholder=" "
          value="<?= htmlspecialchars($parcel['street']) ?>"><label>Street</label></div>
      <div class="fld"><input name="city" placeholder=" "

          value="<?= htmlspecialchars($parcel['city']) ?>"><label>City</label></div>
      <div class="fld">
        <select name="state" required>
          <option value="" hidden></option>
          <?php foreach ($this->var('states', []) as $code => $name): ?>
            <option
              value="<?= $code ?>"
              <?php if ($code === $parcel['state']): ?>
              selected
              <?php endif ?>><?= $name ?></option>
          <?php endforeach ?>
        </select>
        <label>State</label>
      </div>
      <div class="fld"><input name="zip" placeholder=" "
          value="<?= htmlspecialchars($parcel['zip']) ?>"><label>ZIP</label></div>

      <div class="fld"><textarea name="notes" placeholder=" " rows="3"><?= htmlspecialchars($parcel['notes']) ?></textarea><label>Notes</label></div>

      <div id="blocks"></div>
      <div class="flex-right">
        <button class="btn" type="button" onclick="addBlock()">Add Block</button>
      </div>
      <div class=button-set>
        <button class="btn" type="submit">
          <?php if ($parcel['id']): ?>
            Update
          <?php else: ?>
            Create
          <?php endif ?>
        </button>
        <button class="btn cancel" type="button" onclick="window.history.back()">Cancel</button>
      </div>
      
    </form>
  </div>
  <script>
    let idx = 0;

    function addBlock(data) {
      if (data) {
        idx = data.idx;
      }
      const d = document.createElement('div');
      d.className = 'card';
      d.innerHTML = `
  <div class="card-header">
    <h3>Block ${idx + 1}</h3>
    <button class="btn" type="button" onclick="this.closest('div.card').remove()">Remove</button>
  </div>
  <div class="card-content">
    <div class="fld"><input name="blocks[\${idx}][name]" placeholder=" " required><label>Block Name</label></div>
    <div class="fld">
    <select name="blocks[\${idx}][crop_category]" placeholder=" ">
      <option value="" hidden></option>
      <?php foreach ($crop_category as $cat): ?>
        <option value="<?= $cat ?>"><?= htmlspecialchars($cat) ?></option>
      <?php endforeach ?>
    </select>
    <label>Usage Type</label></div>
    <div class="fld"><input type="number" step="0.01" name="blocks[\${idx}][acres]" placeholder=" "><label>Acres</label></div>
    <div class="fld"><textarea name="blocks[\${idx}][notes]" placeholder=" " rows="2"></textarea><label>Notes</label></div>
  </div>
  <div class="card-footer">
  </div>

  `;
      document.getElementById('blocks').appendChild(d);
      idx++;
    }
  </script>
</div>