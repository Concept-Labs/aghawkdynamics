<style>
  #parcel-form {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
  }

  #parcel-form h2 {
    text-align: center;
    margin-bottom: 20px;
  }

  /* ───────── modal styles ───────── */
  #blockModal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, .4);
    opacity: 0;
    visibility: hidden;
    transition: .2s;
    z-index: 500;
  }

  #blockModal.show {
    opacity: 1;
    visibility: visible
  }

  .modal-card {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    width: 340px;
    padding: 1rem;
    max-height: 90vh;
    overflow: auto;
  }

  .modal-card h3 {
    margin: 0 0 .6rem
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: .6rem;
    margin-top: .8rem
  }
</style>
<?php

$parcel = $this->var('parcel', []);
?>
<div id="parcel-form">
  <div class="button-top-set">
                <a class="btn" href="javascript:void(0)" onclick="openBlockModal()">Add Block</a>
                <a class="btn" href="/?q=parcel/export">Export</a>
            </div>
  <div class="card">

    <h2>
      <?php if ($parcel['id']): ?>
        Edit Parcel
      <?php else: ?>
        Add Parcel
      <?php endif ?>
    </h2>
    <form method="post">
      <div class="fld"><input name="parcel[name]" placeholder=" " required
          value="<?= htmlspecialchars($parcel['name']) ?>"><label>Identifier</label></div>
      <div class="fld"><input name="parcel[street]" placeholder=" "
          value="<?= htmlspecialchars($parcel['street']) ?>"><label>Street</label></div>
      <div class="fld"><input name="parcel[city]" placeholder=" "

          value="<?= htmlspecialchars($parcel['city']) ?>"><label>City</label></div>
      <div class="fld">
        <select name="parcel[state]" required>
          <option value="" hidden></option>
          <?php foreach ($this->var('states', []) as $code => $name): ?>
            <option
              value="<?= $code ?>"
              <?php if ($code === $parcel['state']): ?>
              selected
              <?php endif ?>><?= $name ?></option>
          <?php endforeach ?>
        </select>
        <label>State</label>
      </div>
      <div class="fld"><input name="parcel[zip]" placeholder=" "
          value="<?= htmlspecialchars($parcel['zip']) ?>"><label>ZIP</label></div>

      <div class="fld"><textarea name="parcel[notes]" placeholder=" " rows="3"><?= htmlspecialchars($parcel['notes']) ?></textarea><label>Notes</label></div>

      <div id="blocks"></div>

      <div class=button-set>
        <?php if ($parcel['id']): ?>
          <button class="btn danger" type="button">Delete</button>
        <?php endif ?>
        <button class="btn cancel" type="button" onclick="window.history.back()">Cancel</button>
        <button class="btn" type="submit">
          <?php if ($parcel['id']): ?>
            Save
          <?php else: ?>
            Create
          <?php endif ?>
        </button>
      </div>

    </form>
  </div>

</div>

<div id="blockModal">
  <div class="modal-card">
    <h3 id="modalTitle">Add Block</h3>

    <div class="fld"><input id="m_name" placeholder=" " required><label>Identifier</label></div>

    <div class="fld">
      <select id="m_crop">
        <option value="" hidden></option>
        <?php foreach ($crop_category as $cat): ?>
          <option value="<?= $cat ?>"><?= htmlspecialchars($cat) ?></option>
        <?php endforeach ?>
      </select>
      <label>Usage Type</label>
    </div>

    <div class="fld"><input type="number" step="0.01" id="m_acres" placeholder=" "><label>Acres</label></div>
    <div class="fld"><textarea id="m_notes" placeholder=" " rows="2"></textarea><label>Notes</label></div>

    <div class="modal-footer">
      <button class="btn cancel" type="button" onclick="closeBlockModal()">Cancel</button>
      <button class="btn" type="button" onclick="saveBlock()">Save</button>
    </div>
  </div>
</div>

<script>
  let blkIdx = document.querySelectorAll('#blocks .card').length; // якщо редагування
  function openBlockModal() {
    document.getElementById('blockModal').classList.add('show');
  }

  function closeBlockModal() {
    document.getElementById('blockModal').classList.remove('show');
    document.getElementById('blockModal').querySelectorAll('input,textarea,select').forEach(el => el.value = '');
  }

  function saveBlock() {
    closeBlockModal();
  }
</script>