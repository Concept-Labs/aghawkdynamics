<?php

use App\Core\Config;
use App\Core\Debug;

$user = $this->getParam('user') ?? [];

?>
<h2>My Profile</h2>
<div class="card">
    <form method="post" id="profile-form" onsubmit="return submitProfile()">
        <div class="fld"><input name="name" value="<?= htmlspecialchars($user['name']) ?>" placeholder=" "><label>Name</label></div>
        <div class="fld"><input name="street" value="<?= htmlspecialchars($user['street']) ?>" placeholder=" "><label>Street</label></div>
        <div class="fld"><input name="city" value="<?= htmlspecialchars($user['city']) ?>" placeholder=" "><label>City</label></div>
        <div class="fld">
            <select name="state">
                <?php
                foreach (Config::get('states') as $code => $name): ?>
                    <option value="<?= $code ?>" <?= $user['state'] === $code ? 'selected' : '' ?>><?= $name ?></option>
                <?php endforeach ?>
            </select>
            <label>State</label>
        </div>
        <div class="fld"><input name="zip" value="<?= htmlspecialchars($user['zip']) ?>" placeholder=" "><label>ZIP</label></div>
        <div class="fld"><input name="phone" value="<?= htmlspecialchars($user['phone']) ?>" placeholder=" "><label>Phone</label></div>

        <fieldset id="billing" class="card hidden">
            <legend>Billing Address</legend>
            <div class="fld"><input name="billing_street" placeholder=" " value=""><label>Billing street</label></div>
            <div class=" fld"><input name="billing_city" placeholder=" "><label>Billing city</label></div>
            <div class="fld">
                <select name="state">
                    <option value="" selected disabled hidden></option>
                    <?php foreach ($states as $code => $name): ?>
                        <option value="<?= $code ?>"><?= $name ?></option>
                    <?php endforeach ?>
                </select>
                <label>State</label>
            </div>
            <div class="fld"><input name="billing_zip" placeholder=" "><label>Billing ZIP</label></div>
        </fieldset>
        <div id="change-password-container">
            <fieldset id="password" class="card">
            <legend>Change Password</legend>
            <div class="fld"><input type="password" name="old_password" placeholder=" "><label>Old password</label></div>
            <div class="fld"><input type="password" name="password" placeholder=" "><label>New password</label></div>
            <div class="fld"><input type="password" name="password_repeat" placeholder=" "><label>Repeat new password</label></div>
        </fieldset>
        </div>
        
        <button class="btn" type="submit">Update</button>
    </form>
</div>
<script>
    function submitProfile() {
        return checkPassword();
    }

    function checkPassword() {
        const password = document.querySelector('input[name="password"]').value;
        let old_password = '';
        let password_repeat = '';
        if (password.length > 0) {
                old_password = document.querySelector('input[name="old_password"]').value;
                password = document.querySelector('input[name="password"]').value;
                password_repeat = document.querySelector('input[name="password_repeat"]').value;
                if (password !== password_repeat) {
                    alert('Passwords do not match');
                    return false;
                }
                if (password.length < 8) {
                    alert('Password must be at least 8 characters long');
                    return false;
                }
                if (password === old_password) {
                    alert('New password must be different from old password');
                    return false;
                }
                // if (!/[A-Z]/.test(password)) {
                //     alert('Password must contain at least one uppercase letter');
                //     return false;
                // }
                // if (!/[a-z]/.test(password)) {
                //     alert('Password must contain at least one lowercase letter');
                //     return false;
                // }
                // if (!/[0-9]/.test(password)) {
                //     alert('Password must contain at least one number');
                //     return false;
                // }
                // if (!/[!@#$%^&*]/.test(password)) {
                //     alert('Password must contain at least one special character');
                //     return false;
                // }
        }
    }
         
</script>