<?php

use App\Core\Request;
use App\Model\Account;
use App\Model\Account\User;

$request = Request::getInstance();
?>
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AGHAWK Portal</title>
  <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="/css/themes/aghwk.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/topnav.css">
  <link rel="stylesheet" href="/css/tooltipeable.css">
  <link rel="stylesheet" href="/css/minimap.css">
  <link rel="stylesheet" href="/css/switch.css">
  <script src="/js/app.js"></script>

  <style>
    #admin-notice {
      position: absolute;
      opacity: 0.7;
      top: 0;
      left: 33%;
      right: 33%;
      
      padding: .3rem;
      
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      color: #fff;
      text-align: center;
      z-index: 1000;
    }

    .theme-toggle {
      position: relative;
      width: 34px;
      height: 34px;
      border:1px solid #ccc;
      border-radius: 50%;
      box-shadow: var(--shadow);
      cursor: pointer;
      overflow: visible;
    }

    .theme-current {
      position: absolute;
      inset: 0;
      border-radius: 50%;
    }

    .theme-menu {
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 6px;
      display: flex;
      gap: 6px;
      padding: .45rem .6rem;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      opacity: 0;
      visibility: hidden;
      transform: translateY(6px);
      transition: opacity .15s ease, transform .15s ease;
      z-index: 200;
    }

    .theme-menu.show {
      opacity: 1;
      visibility: visible;
      transform: none
    }

    .theme-btn {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, .1);
      cursor: pointer;
    }

    .theme-btn.active {
      box-shadow: 0 0 0 3px var(--accent)
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      const toggle = document.getElementById('themeToggle');
      const menu = document.getElementById('themeMenu');
      const current = toggle.querySelector('.theme-current');
      const btns = menu.querySelectorAll('.theme-btn');

      function applyTheme(t) {
        document.body.className = document.body.className.replace(/\btheme-\w+\b/g, '').trim();
        document.body.classList.add('theme-' + t);
        localStorage.setItem('theme', t);
        document.cookie = `theme=${t}; path=/; max-age=${60*60*24*365}`;

        btns.forEach(b => b.classList.toggle('active', b.dataset.theme === t));
        /* колір для кружечка поточної теми */
        const src = Array.from(btns).find(b => b.dataset.theme === t);
        if (src) current.style.background = src.style.background;
      }

      applyTheme(localStorage.getItem('theme') || 'light');

      toggle.addEventListener('click', e => {
        menu.classList.toggle('show');
        e.stopPropagation();
      });
      document.addEventListener('click', () => menu.classList.remove('show'));

      btns.forEach(b => b.addEventListener('click', e => {
        applyTheme(b.dataset.theme);
        menu.classList.remove('show');
        e.stopPropagation();
      }));
    });
  </script>
</head>

<body <?php echo $request->cookie('theme') ? 'class="theme-' . $request->cookie('theme') . '"' : '' ?>>
    <?php 
      include_once(__DIR__ . '/../dialogs/confirm.phtml');
    ?>
  <header class="flex">
      <?php if (User::isAdmin()): ?>
        <div id="admin-notice" class="admin-notice brand-yellow">
          Administrator mode
        </div>
      <?php endif; ?>
      <div class="logo">
        <img src="/public/img/header-logo.webp" alt="AGHAWK Logo">
        <span style="font-family: 'Orbitron', sans-serif; font-size: 1.5rem;">
          AGHAWK PORTAL
        </span>
      </div>
      <div class="header-right">
        <?php if (User::getInstance()->isLoggedIn()): ?>
          <?php include_once('top-nav.phtml'); ?>
          <div class="user header-right">
              <a href="/?q=account/profile">
                <?= User::getInstance()->getAccount()->get('name') ?>
              </a> |
              <a href="javascript:void(0)" onclick="logoutAction()">Logout</a>
          </div>
        <?php endif; ?>

        <div class="theme-toggle" id="themeToggle">
          <div class="theme-current"></div>
          <div class="theme-menu" id="themeMenu">
            <?php
            $themes = ['light', '#4797a8', 'dark', '#5b6770'];
            for ($i = 0; $i < count($themes); $i += 2):
              $name = $themes[$i];
              $color = $themes[$i + 1]; ?>
              <div class="theme-btn" data-theme="<?= $name ?>" style="background:<?= $color ?>"></div>
            <?php endfor; ?>
          </div>
        </div>
      </div>
      <script>
        logoutAction = () => {
          confirmAction('Are you sure you want to logout?', () => {
            window.location.href = '/?q=auth/logout';
          });
        };
        </script>

  </header>
