<?php

use App\Core\Config;

$blockModel = $this->var('blockModel');
$block = $blockModel?->getData() ?? [];
$parcels = $this->var('parcels', []);
?>
<!-- Leaflet CSS/JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<div class="card entity-form">
  <h2>
    Block info
  </h2>
  <form method="post" id="block-form">
    <input type="hidden" name="block[id]" value="<?= $block['id'] ?>">
    <div class="fld">
      <input name="block[name]" placeholder=" " required value="<?= htmlspecialchars($block['name']) ?>">
      <label>Block Identifier</label>
    </div>
    <div class="fld">
      <?php if ($block['id']): ?>
        <input type="text" disabled value="<?= $blockModel->getParcel()->get('name') ?>">
      <?php else: ?>
        <select name="block[parcel_id]" required>
          <option value="" hidden></option>
          <?php foreach ($parcels as $p): ?>
            <option value="<?= $p['id'] ?>" <?= $p['id'] === $block['parcel_id'] ? 'selected' : '' ?>><?= htmlspecialchars($p['name']) ?></option>
          <?php endforeach ?>
        </select>
      <?php endif ?>
      <label>Parcel</label>

    </div>

    <div class="fld">
      <select name="block[crop_category]" required>
        <option value="" hidden></option>
        <?php foreach (Config::get('crop_category') as $cat): ?>
          <option value="<?= $cat ?>" <?= $cat === $block['crop_category'] ? 'selected' : '' ?>><?= htmlspecialchars($cat) ?></option>
        <?php endforeach ?>
      </select>
      <label>Usage Type</label>
    </div>

    <div class="fld">
      <input type="number" step="0.01" name="block[acres]" placeholder=" " required value="<?= htmlspecialchars($block['acres']) ?>">
      <label>Acres</label>
    </div>
    <div class="fld">
      <textarea name="block[notes]" placeholder=" " rows="2"><?= htmlspecialchars($block['notes']) ?></textarea>
      <label>Notes</label>
    </div>
    <fieldset class="card">
      <legend>Location</legend>
      <div class="fld">
        <input type="hidden" name="block[longitude]" id="longitude" placeholder="" value="<?= htmlspecialchars($block['longitude'] ?? '') ?>">
        <input type="hidden" name="block[latitude]" id="latitude" placeholder="" value="<?= htmlspecialchars($block['latitude'] ?? '') ?>">
        <button type="button" class="btn" onclick="openMapPopup()">Select on Map</button>
      </div>

      <!-- Map Preview -->
      <?php if (!empty($block['longitude']) && !empty($block['latitude'])): ?>
        <div id="minimap" class="minimap" style=""></div>
        <script>
          var minimap, minimapMarker;
          document.addEventListener('DOMContentLoaded', function() {
            minimap = L.map('minimap', {
              attributionControl: false,
              zoomControl: false,
              dragging: false,
              scrollWheelZoom: false,
              doubleClickZoom: false,
              boxZoom: false,
              keyboard: false,
              tap: false,
              touchZoom: false
            }).setView([<?= floatval($block['latitude']) ?>, <?= floatval($block['longitude']) ?>], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(minimap);

            minimapMarker = L.marker([<?= floatval($block['latitude']) ?>, <?= floatval($block['longitude']) ?>]).addTo(minimap);
          });
        </script>
      <?php else: ?>
        <div id="minimap" class="minimap"></div>
        <script>
          var minimap, minimapMarker;
          document.addEventListener('DOMContentLoaded', function() {
            minimap = L.map('minimap', {
              attributionControl: false,
              zoomControl: false,
              dragging: false,
              scrollWheelZoom: false,
              doubleClickZoom: false,
              boxZoom: false,
              keyboard: false,
              tap: false,
              touchZoom: false
            }).setView([39.8283, -98.5795], 4);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(minimap);

            minimapMarker = L.marker([39.8283, -98.5795]).addTo(minimap);
          });
        </script>
      <?php endif; ?>

      <!-- Map Popup Modal -->
      <div id="map-popup" class="map-popup">
        <div class="map-popup-content">
          <div id="map" style="flex:1 1 auto;width:100%;height:100%;"></div>
          <div style="margin-top:1rem;text-align:right;">
            <button type="button" class="cancel" onclick="closeMapPopup()">Cancel</button>
            <button type="button" class="btn" onclick="confirmMapSelection()">Select</button>
          </div>
        </div>
      </div>

      <script>
        let map, marker, selectedLngLat = null;

        function openMapPopup() {
          document.getElementById('map-popup').style.display = 'flex';
          setTimeout(initMap, 100); // Delay to ensure div is visible
        }

        function closeMapPopup() {
          document.getElementById('map-popup').style.display = 'none';
        }

        function initMap() {
          if (map) {
            map.invalidateSize();
            return;
          }

          // Default location or current values
          const lng = parseFloat(document.getElementById('longitude').value) || -98.5795;
          const lat = parseFloat(document.getElementById('latitude').value) || 39.8283;

          map = L.map('map').setView([lat, lng], 4);

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
          }).addTo(map);

          marker = L.marker([lat, lng], {
            draggable: true
          }).addTo(map);

          marker.on('dragend', function(e) {
            selectedLngLat = marker.getLatLng();
          });

          map.on('click', function(e) {
            marker.setLatLng(e.latlng);
            selectedLngLat = e.latlng;
          });

          selectedLngLat = marker.getLatLng();
        }

        function confirmMapSelection() {
          if (!selectedLngLat && marker) selectedLngLat = marker.getLatLng();
          if (selectedLngLat) {
            document.getElementById('longitude').value = selectedLngLat.lng.toFixed(6);
            document.getElementById('latitude').value = selectedLngLat.lat.toFixed(6);

            // Update minimap if it exists
            if (typeof minimap !== 'undefined' && minimap) {
              minimap.setView([selectedLngLat.lat, selectedLngLat.lng], 14);
              if (minimapMarker) {
                minimapMarker.setLatLng([selectedLngLat.lat, selectedLngLat.lng]);
              } else {
                minimapMarker = L.marker([selectedLngLat.lat, selectedLngLat.lng]).addTo(minimap);
              }
            }
          }
          closeMapPopup();
        }
      </script>
    </fieldset>



    <div class=button-set>
      <div>
        <?php if ($block['parcel_id']): ?>
          <button class="btn cancel brand-green" type="button" onclick="location.href='/?q=parcel/edit&id=<?= $block['parcel_id'] ?>'">Go to Parcel</button>
          <?php endif ?>
          <button class="btn cancel brand-yellow" type="button" onclick="location.href='/?q=block/index'">Go to Block list</button>
      </div>
      <div style="display:flex;gap:1rem">
        <form class="" method="post" action="/?q=block/deleteit">
          <input type="hidden" name="block[dp]" value="<?= $block['id'] ?>">
          <?php if ($block['id']): ?>
            <button class="btn delete" type="button" onclick="return confirm('Are you sure you want to delete this block?')">Delete</button>
          <?php endif ?>
        </form>
        <button class="btn end" type="submit">
          <?php if ($block['id']): ?>
            Save
          <?php else: ?>
            Create
          <?php endif ?>
        </button>
      </div>
    </div>
  </form>
</div>