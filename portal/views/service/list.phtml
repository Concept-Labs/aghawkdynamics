<?php

use App\Core\Config;
use App\Model\Account\User;
use App\Model\ServiceRequest;

$requestCollection = $this->var('requestCollection', []);
$statusCssClass = [
    ServiceRequest::STATUS_PENDING => 'brand-yellow ',
    ServiceRequest::STATUS_COMPLETED => 'brand-green',
    ServiceRequest::STATUS_CANCELLED => 'brand-red',
]
?>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
    .o50 {
    opacity: 0.5;
}
    #request-list {
        margin: 0 auto;
        max-width: 1200px;
    }
</style>
<div id="request-list">
    <div class="flex" style="align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <h2>Activity</h2>
        <div class="button-top-set">
            <a class="btn brand-yellow" href="/?q=service/request">Request Service</a>
            <a class="btn brand-green disabled" href="/?q=service/export">Export</a>
        </div>
    </div>


    <table class="grid card">
        <thead>
            <tr>
                <th></th>
                <?php  if (User::isAdmin()):?>
                    <th>Account</th>
                <?php endif; ?>
                <th>Need by Date</th>
                <th>Type</th>
                <th>
                    <input class="tbl-filter inline-search" name="f_name" value="<?= htmlspecialchars($nameFilter) ?>" placeholder="Parcel name">
                </th>
                <th><input class="tbl-filter inline-search" name="f_address" value="<?= htmlspecialchars($addrFilter) ?>" placeholder="Block"></th>
                <th>Status</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($requestCollection as $requestModel): 
                $p = $requestModel->getParcel()->getData();
                ?>
                <tr>
                    <td>
                        <?php if ($p['latitude'] && $p['longitude']): 
                                $minimapUid = uniqid('minimap-');
                            ?>
                                <span class="minimap-tooltip-trigger" style="cursor:pointer;position:relative;">
                                    <img src="https://unpkg.com/leaflet/dist/images/marker-icon.png" alt="Marker" style="width:16px;">
                                    <div class="minimap-tooltip" style="opacity:0;pointer-events:none;transition:opacity 0.25s;position:absolute;left:0;top:1.5em;z-index:1000;background:var(--card);padding:8px;border-radius:var(--radius);box-shadow:var(--shadow);min-width:220px;">
                                        <div style="font-size:12px;margin-bottom:6px;">
                                            Location: <?= htmlspecialchars($p['latitude']) ?>, <?= htmlspecialchars($p['longitude']) ?>
                                        </div>
                                        <div id="<?= $minimapUid ?>" style="width:200px;height:120px;"></div>
                                    </div>
                                </span>
                                <script>
                                    (function() {
                                        var trigger = document.currentScript.previousElementSibling;
                                        var tooltip = trigger.querySelector('.minimap-tooltip');
                                        var minimapId = '<?= $minimapUid ?>';
                                        var minimapInitialized = false;

                                        function showTooltip() {
                                            tooltip.style.opacity = '1';
                                            tooltip.style.pointerEvents = 'auto';
                                            if (!minimapInitialized) {
                                                var map = L.map(minimapId, {
                                                    attributionControl: false,
                                                    zoomControl: false,
                                                    dragging: false,
                                                    scrollWheelZoom: false,
                                                    doubleClickZoom: false
                                                }).setView([<?= $p['latitude'] ?>, <?= $p['longitude'] ?>], 10);

                                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                                    maxZoom: 19,
                                                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                                                }).addTo(map);

                                                L.marker([<?= $p['latitude'] ?>, <?= $p['longitude'] ?>]).addTo(map);
                                                minimapInitialized = true;
                                            }
                                        }

                                        function hideTooltip() {
                                            tooltip.style.opacity = '0';
                                            tooltip.style.pointerEvents = 'none';
                                        }

                                        trigger.addEventListener('mouseenter', showTooltip);
                                        trigger.addEventListener('mouseleave', hideTooltip);
                                    })();
                                </script>
                            
                            <?php endif; ?>
                    </td>
                    <?php if (User::isAdmin()): ?>
                        <td>
                            <a href="/?q=account/profile&id=<?= $requestModel->getAccount()->getId() ?>">
                                <?= htmlspecialchars($requestModel->getAccount()->get('name')) ?>
                            </a>
                        </td>
                    <?php endif; ?>
                    <td><?= (new DateTimeImmutable($requestModel->get('date')))->format(Config::get('date_format')) ?></td>
                    <td><?= htmlspecialchars($requestModel->get('type')) ?></td>
                    <td>
                        <a href="/?q=parcel/edit&id=<?= $requestModel->get('parcel_id') ?>">
                            <?= htmlspecialchars($requestModel->getParcel()->get('name')) ?>
                        </a>
                    </td>
                    <td>
                        <a href="/?q=block/edit&id=<?= $requestModel->get('block_id') ?>">
                            <?= htmlspecialchars($requestModel->getBlock()->get('name')) ?>
                        </a>
                    </td>
                    <td class="<?= $statusCssClass[$requestModel->getStatus()] ?? 'brand-yellow' ?> tooltipable">
                        <span class="status-indicator" style="background-color: <?= $statusCssClass[$requestModel->getStatus()] ?? '#ccc' ?>;"></span>
                        <?= ucfirst(htmlspecialchars($requestModel->getStatus())) ?>
                        <?php 
                            if ($requestModel->getStatus() === ServiceRequest::STATUS_COMPLETED):
                            $completeData = $requestModel->getCompleteData();
                        ?>
                            <tooltip class="tooltip brand-green" style="left: -100%;">
                                <strong>Completion Details</strong>
                                <br>
                                <span >Completed on <?= (new DateTimeImmutable($requestModel->get('completed_at')))->format(Config::get('date_format')) ?></span>
                                <br>
                                <span >Temperature: <?= htmlspecialchars($completeData['temperature'] ?? '') ?>°F</span>
                                <br>
                                <span >Wind Speed: <?= htmlspecialchars($completeData['wind'] ?? '') ?> MPH</span>
                                <br>
                                <span >Restricted Exposure Hours: <?= htmlspecialchars($completeData['exposure_hours'] ?? '') ?></span>

                            </tooltip>
                        <?php endif; ?>
                    </td>
                    <td>
                        <div class="action-wrap" style="position:relative">
                            <button class="action-btn">⋮</button>
                            <div class="actions-menu">
                                <a href="/?q=service/details&id=<?= $requestModel->get('id') ?>">Details</a>
                                <?php if (User::isAdmin() && $requestModel->canComplete()): ?>
                                    <a href="/?q=service/edit&id=<?= $requestModel->get('id') ?>">Edit</a>
                                    <a href="javascript:void(0)" class="hover-brand-green" onclick="completeDialog(<?= $requestModel->get('id') ?>)">Complete</a>
                                    <?php endif; ?>
                                <?php if ($requestModel->canCancel()): ?>
                                <a href="javascript:void(0)" class="danger" onclick="cancelRequest(<?= $requestModel->get('id') ?>)">Cancel Request</a>
                                <?php endif; ?>
                                
                            </div>
                        </div>
                    </td>
                </tr>
            <?php endforeach ?>
        </tbody>
    </table>
</div>
<script>
    cancelRequest = function(id) {
        confirmAction('Are you sure you want to cancel this service request?')
            .then(confirmed => {
                if (confirmed) {
                    
                }
            });
    }
</script>

<?php include_once __DIR__ . '/dialog/complete.phtml'; ?>
        