<?php

use App\Core\Config;
use App\Model\Account\User;
use App\Model\ServiceRequest;

$requestCollection = $this->var('requestCollection', []);
$statusCssClass = [
    ServiceRequest::STATUS_PENDING => 'brand-yellow o50',
    ServiceRequest::STATUS_COMPLETED => 'brand-green o50',
    ServiceRequest::STATUS_CANCELLED => 'brand-red o50',
]
?>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
    .o50 {
    opacity: 0.5;
}
    #request-list {
        margin: 0 auto;
        max-width: 1200px;
    }
</style>
<div id="request-list">
    <div class="flex" style="align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <h2>Activity</h2>
        <div class="button-top-set">
            <a class="btn brand-yellow" href="/?q=service/request">Request Service</a>
            <a class="btn brand-green disabled" href="/?q=service/export">Export</a>
        </div>
    </div>


    <table class="grid card">
        <thead>
            <tr>
                <th></th>
                <?php  if (User::isAdmin()):?>
                    <th>Account</th>
                <?php endif; ?>
                <th>Need by Date</th>
                <th>Type</th>
                <th>
                    <input class="tbl-filter inline-search" name="f_name" value="<?= htmlspecialchars($nameFilter) ?>" placeholder="Parcel name">
                </th>
                <th><input class="tbl-filter inline-search" name="f_address" value="<?= htmlspecialchars($addrFilter) ?>" placeholder="Block"></th>
                <th>Status</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($requestCollection as $requestModel): 
                $p = $requestModel->getParcel()->getData();
                ?>
                <tr>
                    <td>
                        <?php if ($p['latitude'] && $p['longitude']): 
                                $minimapUid = uniqid('minimap-');
                            ?>
                                <span class="minimap-tooltip-trigger" style="cursor:pointer;position:relative;">
                                    <img src="https://unpkg.com/leaflet/dist/images/marker-icon.png" alt="Marker" style="width:16px;">
                                    <div class="minimap-tooltip" style="opacity:0;pointer-events:none;transition:opacity 0.25s;position:absolute;left:0;top:1.5em;z-index:1000;background:var(--card);padding:8px;border-radius:var(--radius);box-shadow:var(--shadow);min-width:220px;">
                                        <div style="font-size:12px;margin-bottom:6px;">
                                            Location: <?= htmlspecialchars($p['latitude']) ?>, <?= htmlspecialchars($p['longitude']) ?>
                                        </div>
                                        <div id="<?= $minimapUid ?>" style="width:200px;height:120px;"></div>
                                    </div>
                                </span>
                                <script>
                                    (function() {
                                        var trigger = document.currentScript.previousElementSibling;
                                        var tooltip = trigger.querySelector('.minimap-tooltip');
                                        var minimapId = '<?= $minimapUid ?>';
                                        var minimapInitialized = false;

                                        function showTooltip() {
                                            tooltip.style.opacity = '1';
                                            tooltip.style.pointerEvents = 'auto';
                                            if (!minimapInitialized) {
                                                var map = L.map(minimapId, {
                                                    attributionControl: false,
                                                    zoomControl: false,
                                                    dragging: false,
                                                    scrollWheelZoom: false,
                                                    doubleClickZoom: false
                                                }).setView([<?= $p['latitude'] ?>, <?= $p['longitude'] ?>], 10);

                                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                                    maxZoom: 19,
                                                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                                                }).addTo(map);

                                                L.marker([<?= $p['latitude'] ?>, <?= $p['longitude'] ?>]).addTo(map);
                                                minimapInitialized = true;
                                            }
                                        }

                                        function hideTooltip() {
                                            tooltip.style.opacity = '0';
                                            tooltip.style.pointerEvents = 'none';
                                        }

                                        trigger.addEventListener('mouseenter', showTooltip);
                                        trigger.addEventListener('mouseleave', hideTooltip);
                                    })();
                                </script>
                            
                            <?php endif; ?>
                    </td>
                    <?php if (User::isAdmin()): ?>
                        <td>
                            <a href="/?q=account/edit&id=<?= $requestModel->getAccount()->getId() ?>">
                                <?= htmlspecialchars($requestModel->getAccount()->get('name')) ?>
                            </a>
                        </td>
                    <?php endif; ?>
                    <td><?= (new DateTimeImmutable($requestModel->get('date')))->format(Config::get('date_format')) ?></td>
                    <td><?= htmlspecialchars($requestModel->get('type')) ?></td>
                    <td>
                        <a href="/?q=parcel/edit&id=<?= $requestModel->get('parcel_id') ?>">
                            <?= htmlspecialchars($requestModel->getParcel()->get('name')) ?>
                        </a>
                    </td>
                    <td>
                        <a href="/?q=block/edit&id=<?= $requestModel->get('block_id') ?>">
                            <?= htmlspecialchars($requestModel->getBlock()->get('name')) ?>
                        </a>
                    </td>
                    <td class="<?= $statusCssClass[$requestModel->getStatus()] ?? 'brand-yellow' ?>">
                        <span class="status-indicator" style="background-color: <?= $statusCssClass[$requestModel->getStatus()] ?? '#ccc' ?>;"></span>
                        <?= ucfirst(htmlspecialchars($requestModel->getStatus())) ?>
                    </td>
                    <td>
                        <div class="action-wrap" style="position:relative">
                            <button class="action-btn">â‹®</button>
                            <div class="actions-menu">
                                <a href="/?q=service/details&id=<?= $requestModel->get('id') ?>">Details</a>
                                <?php if ($requestModel->canCancel()): ?>
                                <div class="sep"></div>
                                <?php if (User::isAdmin()): ?>
                                    <a href="/?q=service/edit&id=<?= $requestModel->get('id') ?>">Edit</a>
                                    <a href="javascript:void(0)" class="hover-brand-green" onclick="completeDialog(<?= $requestModel->get('id') ?>)">Complete</a>
                                <?php endif; ?>
                                <a href="/?q=service/cancel&id=<?= $requestModel->get('id') ?>" class="danger">Cancel Request</a>
                                <?php endif; ?>
                                
                            </div>
                        </div>
                    </td>
                </tr>
            <?php endforeach ?>
        </tbody>
    </table>
</div>

<style>
    dialog#completeDialog {
        border: none;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        padding: 0;
        max-width: 380px;
        width: 95%;
        background: var(--card, #fff);
        animation: fadeInDialog 0.2s;
    }
    @keyframes fadeInDialog {
        from { transform: translateY(30px) scale(0.98); opacity: 0; }
        to { transform: translateY(0) scale(1); opacity: 1; }
    }
    .modal-card {
        padding: 2rem 1.5rem 1.5rem 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }
    .modal-card h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--brand, #222);
    }
    .modal-card p {
        margin: 0 0 1rem 0;
        color: #555;
        font-size: 1rem;
    }
    .button-set {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
    }
    .btn.cancel {
        background: #f5f5f5;
        color: #444;
        border: 1px solid #ddd;
    }
    .btn.brand-green {
        background: #27ae60;
        color: #fff;
        border: none;
    }
    dialog#completeDialog::backdrop {
        background: rgba(30, 30, 30, 0.25);
        backdrop-filter: blur(2px);
    }
</style>
<dialog id="completeDialog">
    <form method="post" action="/?q=service/complete">
        <input type="hidden" name="id" value="">
        <div class="modal-card">
            <h3>Complete Service Request</h3>
            <div class="fld">
                <input type="date" name="completion_date" required>
                <label for="completion_date">Completion Date</label>
            </div>
            <div class="fld">
                <input type="number" name="temperature" step="0.1" min="0" max="100" required>
                <label for="temperature">Temperature (Â°F)</label>
            </div>
            <div class="fld">
                <input type="number" name="wind" step="0.1" min="0" max="100" required>
                <label for="wind">Wind Speed (MPH)</label>
            </div>
            <div class="fld">
                <input type="number" name="exposure_hours" step="1" min="0" required>
                <label for="exposure_hours">Restricted Exposure Hours (per label)</label>
            </div>
            <div class="button-set">
                <button type="button" class="btn cancel" onclick="document.getElementById('completeDialog').close()">Cancel</button>
                <button type="submit" class="btn brand-green">Complete</button>
            </div>
        </div>
    </form>
</dialog>
<script>
    completeDialog = function(id) {
        var dialog = document.getElementById('completeDialog');
        dialog.querySelector('input[name="id"]').value = id;
        dialog.showModal();
    };
    document.addEventListener('DOMContentLoaded', function() {

    });
</script>
        